---
- hosts: text
  remote_user: root
  serial: 3
  vars:
    local_key_dir: "/root/file/local_login.py"
    remote_script_dir: "/root/ansible/script/python/local_login.py"
    env_dir: "/root/file"
    env_source_dir: /root/python/env
  tasks:
    - name: 创建临时目录
      file:
        path: "/root/file"
        state: directory
        owner: root
        group: root
#-----------------------------Debian部分----------------
    - block:

      - name: 安装python3-venv
        apt:
          name: python3-venv
          state: present
 
      - name: 创建虚拟环境目录
        command: "/usr/bin/python3 -m venv /root/python/env"
        args:
          creates: "/root/python/env/bin/pip"

      - name: 安装python-setuptools
        apt:
          name: python-setuptools
          state: present
          
      - name: Pip安装 pexpect 
        pip:
          name: pexpect
          executable: "/root/python/env/bin/pip3"
      when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"

   
#---------------------------------Centos部分---------------------
    - block:
      - name: 添加python34-devel依赖仓库
        yum_repository:
          name: tbi.EPEL7.repo
          description: home:tbi:EPEL7 (CentOS_7)
          baseurl: http://download.opensuse.org/repositories/home:/tbi:/EPEL7/CentOS_7/
          gpgcheck: no


      - name: 安装EPEL源
        package:
          name: '{{ item }}'
          state: present
          update_cache: yes
        with_items:
          - epel-release
          


      - name: python34环境
        package:
          name: '{{ item }}'
          state: present
          update_cache: yes
        with_items:
          - python34
          - python34-pip
          - python34-virtualenv
          - python-setuptools
          
      - name: 创建虚拟环境
        command: "/usr/bin/virtualenv-3.4  /root/python/env"
        args:
          creates: "/root/python/env"
        # shell: "/usr/bin/virtualenv-3.4  /root/python/env" 

      # - name: Pip安装SetupTools
      #   pip:
      #     name: python-setuptools
      #     executable: "/root/python/env/bin/pip"

      - name: Pip安装 pexpect 
        pip:
          name: pexpect
          executable: "/root/python/env/bin/pip"

      when: ansible_distribution == "CentOS" or ansible_distribution == "Red Hat Enterprise Linux"
    


   
#----------------------公共------------

    - name: 复制脚本到目标主机
      copy:
        src: '{{ remote_script_dir }}'
        dest: '{{ local_key_dir }}'
        owner: root
        group: root
        mode: 0744


    - name: 执行本地密钥安装
      shell: "{{ env_source_dir }}/bin/python {{ local_key_dir }}"